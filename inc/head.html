<link href='http://fonts.googleapis.com/css?family=Source+Code+Pro|Droid+Sans' rel='stylesheet' type='text/css'>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<script>
    $(document).ready(function() {
      $("body").wrapInner("<div class=\"book\"></div>")
      answers();
      appendices
      chapters();
      epigraphs();
      figures();
      tables();

      references();
      toc();
    });

    function chapters(){
      $("h1:not(.appendix):not(.preface)").each(function(index){
        $(this).prepend("Chapter " + (index+1) + ". ")
      })
      $("h1:not(.appendix):not(.preface)").nextUntil("h1").wrapAll("<div class=\"chapter\"></div>");
      $("h1.appendix").nextUntil("h1").wrapAll("<div class=\"appendix\"></div>");
      $("h1.preface").nextUntil("h1").wrapAll("<div class=\"preface\"></div>");
    }

    function appendices(){
     $("h1.appendix").each(function(index){
        $(this).prepend("Appendix " + String.fromCharCode(65 + index) + ". ")
      })
    }

    function tables(){
      $("table > caption").each(function(index){
        $(this).prepend("Table " + (index+1) + ". ")
      })
    }

    function figures(){
      $("figure > figcaption").each(function(index){
        $(this).prepend("Figure " + (index+1) + ". ")
      })
    }

    function references(){
      $("a.cite").each(
        function(){
          var xid = $(this).attr("href");
          var val = $(xid).index() + 1; // 0 based
          $(this).append("[" + val + "]")
        }
      );

      $("a:empty, [href^='#']").each(
        function(){
          // Skip class=cite.
          if ($(this).hasClass("cite")) {
              return
          }
          var xid = $(this).attr("href");
          // Split out the different things we can reference.
          if ($(xid).is("table")) {
              $(this).append("Table " + ($("table").index($(xid)) + 1));
              return;
          }
          if ($(xid).is("figure")) {
              $(this).append("Figure " + ($("figure").index($(xid)) + 1));
              return;
          }
          var val = $(xid).text();
          $(this).append(val);
        }
      );
    }

    function epigraphs() {
      $("blockquote.epigraph footer").prepend("<hr>");
    }

    function answers(){
       $("h3.answer").after("<summary>Click to see the answer</summary>");
       $("h3.answer").nextUntil("h1,h2").wrapAll("<details></details>");
    }

    function toc(){
      $("body").prepend("<ul class=\"toc\"></ul>");
      $("h1,h2").each(function(){
              // Need sublists for H2.
              $("ul.toc").append("<li class=\"toc-" + $(this)[0].tagName.toLowerCase() + "\">" +
                  "<a href=\"#" + $(this).attr("id") + "\">" + $(this).text()).append("</a></li>");
      });
    }
</script>
